# Offline Ergodox gui configuration tool for Ubuntu(and just maybe windows)
### You can configure your Ergodox for any layout 
You press a key and this tool guesses what your keyboard sends to the PC and make 
ergodox copy that. 

### WARNING  
This tool has only been tested with ubuntu16LTS with a JIS keyboard, 
thus likely contains uncaught bugs for other types of keyboards
and platforms.  
When used on Windows OS, this script only generates
kemap.c file and you must compile the file yourself.  
And as usual, this script comes with no warrant of fitness, no support, 
you are on your own and a developer yourself.

### Drawbacks
The keyboard layout you use to configure your Ergodox and the keyboard layout 
you will be using with your ergodox must match.  
![Alt text](image4288.png?raw=true "Title")
  

### How does this work?
By capturing x11 keycode(key position) and guessing the signal the keyboard sent to
generate it; `/NoneGUIComponents/x11_to_hid_usage_id_map.py` is the
conversion map.

### Does this work with other linux distributions?
I do not know...   
Linux translates what the keyboard sends in chains:  

    1. keyboard sends hidbp packets containing hid usage id 
    2. driver translates it to kernel keycode(similar to scancode set one)
    3. xserver translates kernel keycode to x11 keycode 
    4. xserver translates x11 keycode to literals like a,b,c,...z etc.
   
For the sake of compatibility, I'm guessing most linux distributions share
the translation rule in the above process. Only a guess though.


## Dependencies:  

    d@d:~/PycharmProjects/GUIConfigurator$ pipreqs $(pwd)
    INFO: Successfully saved requirements file in /home/d/PycharmProjects/GUIConfigurator/requirements.txt
    d@d:~/PycharmProjects/GUIConfigurator$ cat requirements.txt 
    six==1.10.0
    setuptools==20.7.0
    evdev==0.7.0
    PyQt5==5.9
    blessings==1.6
    intelhex==2.1
    pywinusb==0.4.2
    pyusb==1.0.0
    
qmk_firmware:https://github.com/qmk/qmk_firmware  
You do not need to install or anything but my script internally uses 
some portion of pyxhook code: https://github.com/JeffHoogland/pyxhook

For windows, the following packages also need to be installed:  
pyhook: https://pypi.python.org/pypi/pyHook  
PyWin32  

## Installation

    sudo apt-get update
    sudo apt-get install gcc unzip wget zip gcc-avr binutils-avr avr-libc dfu-programmer dfu-util gcc-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi
    sudo apt install python3.5 python3-pip evdev python3-xlib python3-pyqt5
    git clone https://github.com/hiro2016/ergodox_gui_configurator.git

## Windows build instruction

    # Download with you browser and install
    Install python 3.6:https://www.python.org/downloads/release/python-362/
    Install pyhoox # wheel available from http://www.lfd.uci.edu/~gohlke/pythonlibs
    Install  PyWin32  # wheel available from http://www.lfd.uci.edu/~gohlke/pythonlibs
    # command line
    # Installing from wheel file: 
    # e.g. 
    #   pip install pyHook-1.5.1-cp36-cp36m-win_amd64.whl
    # cp36 means python3.6, amd64 means 64bits processor compatible.
    pip install six
    pip --default-timeout=600000 install PyQt5
    # At this point `python main.py` should be runnable.

    #Creating an executable file.
    pip install cx_freeze
    # after installing cx_freeze you should run `python cxfreeze-postinstall` at`/python-dir/Scripts`
    python setup.py build

## Running
For linux:

    cd ergodox_gui_configurator.git
    python3 ./main.py

For windows:

    cd ergodox_gui_configurator.git
    python ./main.py
    # or if you have built it or have downloaded windows branch  
    build\exe.win32-3.6\main.exe

Compile button is not available for windows. 

### General
Ignore the configure button. It's for switching qmk_firmware dir.
    
    
![Alt text](main.png?raw=true "Title")    


 - Open File button only let you load ekm files generated by this script.    
 - Compile button copy files to appropriate directories and runs the make command. 
See the pop up for the location of the generated hex file.  
 - Save As button saves the instance state, so you can load it to this script later.
    
![Alt text](key_configurator.png?raw=true "Title")  
To configure a key in type-to-configure mode, toggle on the topmost radio
button and select the input-literal text field, then type a key on a 
standard keyboard.
  
Modifier mask comboboxies are for sending shift, control etc along with the hid id;
some action code such as LT do not support this option.  
  
Set-this-key-as-DLT-key button allows you to use a Macro version of LT which
provides more control.  
For more details read:https://github.com/hiro2016/ergodox_gui_configurator/blob/master/README_DLT.md 
  
Do note what is shown in the input literal and key's name fields are irrelevant to 
your ergodox, only the HID usage id and modifier masks matter.
  
    
### Currently escaped scancodes are not supported in type-to-configure mode
Use choose from list
  

![Alt text](key_configurator_choose_from_list_selected.png?raw=true "Title")

It's due to code collisions:
e.g.    

    hid_id  scancode_set_1      keyname  
    70 	    e0-37           PrtScr    
    85 	    37 	            KP-*    
    
If you wish you can edit GUIComponents/SelectSpecialActionComponent:

        #"display stirng":"the value inserted into keymap."
        qmk_options = {
            "None":None,
            "TT":"TT",
            "MO":"MO",
            "TO":"TO",
            "TG":"TG",
            "RESET":"RESET",
            "- and _(us only)":'0x2d',
            "Mute":'0x7f',
            "= and +(us only)":'0x2e',
            '\' and \"(us only)':'0x34',
            'Pause': '0x48',
            'Keyboard Scroll Lock': '0x47',
            'PrintScreen': '0x46',
            'Volume Up':  '0x80',
            'Volume Down':  '0x81',

and add new hid usage id options. You can find ids at: http://www.usb.org/developers/hidpage/Hut1_12v2.pdf

### Known issues  
The mapping between x11 keycodes and hid usage ids are 
incomplete; in type-to-configure-mode pressing some keys 
may crash the script.  
The code is ugly beyond words.  

### Update note  
***
+ Decided to split CLT receptor code output into to macro codes:
    e.g.  
    
        //macro 1
        case 1:  
            ...
            //calls macro 2
            break;
        case 2:
            ...
            break;
            
    This new approach makes generated code a little more readable. 
    And makes GUIConfigurator a lot more unreadable.  
    My original configurator design assumed:
     1. each macro generator does not reference it's own id  
     2. each macro gets macro id at compile time and not when key configuration is done.
     3. each configuratior's macro generation script generates only one macro.  
     
    All the three no longer hold.  
    And now given that dict is a dictionary object containing a set of 
    configuration values for a single keyboard key:  
    + `dict[key_macro]` 
    Returns dict  
    +  `dict[key_macro][key_macro_ids]`  
    Returns ids used by the key configurator;now up to two ids are 
    used but only the first is referenced from KEYMAP macro.  
    + `dict[MacroEdior.key_macro][key_macro_code]`  
    Returns the code to be inserted into `action_get_macro` for a single macro call.
    + `dict[MacroEdior.key_macro][key_macro_type]`  
    Returns which macro generation script was used to generate the macro.  
      
      
## Todo  
Using an unique dictionary object to hold a configuration value set 
for each key is cool but getting and setting is a lot of work.   
Ensure:
 1. Using KeyDictParser to get values.
 2. Write a dictionary generator to make sure dict objects are initialized properly.  
 3. Introduce dict_key.py file to have all dict keys in one place.
    
    
    
     
